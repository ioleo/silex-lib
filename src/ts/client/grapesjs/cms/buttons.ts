import { Editor } from 'grapesjs'
import { ClientConfig } from '../../config'
import { COMMAND_REFRESH, DATA_SOURCE_CHANGED, DATA_SOURCE_DATA_LOAD_CANCEL, DATA_SOURCE_DATA_LOAD_END, DATA_SOURCE_DATA_LOAD_START, DATA_SOURCE_ERROR } from '@silexlabs/grapesjs-data-source'

document.querySelector('head')?.insertAdjacentHTML('beforeend', `
  <style>
  .data-source-refresh {
    &.fa-refresh:before {
      content: "\\f021";
      font-weight: 900;
    }
    &.fa-refresh:hover {
      transform: rotate(180deg);
      transition: transform 0.5s;
    }
    &.fa-spinner:before {
      content: "\\f110";
      font-weight: 900;
    }
    &.fa-spinner {
      animation: fa-spin 2s infinite linear;
    }
    &.fa-exclamation-triangle:before {
      content: "\\f071";
      font-weight: 900;
    }
  }
  </style>
`)

const REFRESH_BUTTON_BASE_CLASS = 'fa fa-fw data-source-refresh'

export default function(editor: Editor/*, opts: EleventyPluginOptions*/): void {
  editor.Panels.addButton('options', {
    id: 'refresh-data-sources',
    className: `${REFRESH_BUTTON_BASE_CLASS} fa-refresh`,
    command: () => {
      // Refresh all data sources
      editor.runCommand(COMMAND_REFRESH)
    },
    togglable: false,
    attributes: { title: 'Refresh data sources' },
  })
  editor.on(DATA_SOURCE_DATA_LOAD_START, () => {
    const button = editor.Panels.getButton('options', 'refresh-data-sources')
    if (button) {
      button.set('className', `${REFRESH_BUTTON_BASE_CLASS} fa-spinner`)
      button.set('title', 'Refreshing data sources')
    }
  })
  editor.on(`
    ${ DATA_SOURCE_DATA_LOAD_END }
    ${ DATA_SOURCE_DATA_LOAD_CANCEL }
  `, () => {
    const button = editor.Panels.getButton('options', 'refresh-data-sources')
    if (button) {
      button.set('className', `${REFRESH_BUTTON_BASE_CLASS} fa-refresh`)
      button.set('title', 'Refresh data sources')
    }
  })
  editor.on(DATA_SOURCE_ERROR, (error: Error) => {
    console.error('Data source error', error)
    const button = editor.Panels.getButton('options', 'refresh-data-sources')
    if (button) {
      button.set('className', `${REFRESH_BUTTON_BASE_CLASS} fa-exclamation-triangle`)
      button.set('title', 'Error refreshing data sources, check the notifications')
    }
  })
}
